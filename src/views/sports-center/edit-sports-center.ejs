<%- include('../partials/header') %>
    <!-- END #header -->
    <!-- BEGIN #sidebar -->
    <%- include('../partials/sidebar') %>
        <!-- END #sidebar -->
        <!-- BEGIN #content -->
        <div id="content" class="app-content">
            <div class="d-flex align-items-center mb-3">
                <div>
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="javascript:;">Dashboard</a></li>
                        <li class="breadcrumb-item active">
                            <%= title %>
                        </li>
                    </ol>
                    <h1 class="page-header mb-0">
                        <%= sportsCenter.sports_center_name %>
                    </h1>
                </div>
                <div class="ms-auto">
                    <button class="btn btn-theme" data-bs-toggle="modal" data-bs-target="#modalCoverExample"><i
                            class="fa fa-plus-circle fa-fw me-1"></i> Add Courts</button>
                </div>
            </div>
            <% if (success_msg.length> 0) { %> <div class="alert alert-success">
                    <%= success_msg[0] %>
                </div>
                <% } %>
                    <% if (error_msg.length> 0) { %> <div class="alert alert-danger">
                            <%= error_msg[0] %>
                        </div>
                        <% } %>
                            <!-- <div class="mb-md-3 mb-2 d-flex flex-wrap">
                <div class="me-4 mb-md-0 mb-2"><a href="#"
                        class="text-decoration-none text-body d-flex align-items-center"><i
                            class="fa fa-print me-2 text-body text-opacity-50 my-n1"></i> Print</a></div>
                <div class="me-4 mb-md-0 mb-2"><a href="#"
                        class="text-decoration-none text-body d-flex align-items-center"><i
                            class="fa fa-box me-2 text-body text-opacity-50 my-n1"></i> Restock items</a></div>
                <div class="me-4 mb-md-0 mb-2"><a href="#"
                        class="text-decoration-none text-body d-flex align-items-center"><i
                            class="fa fa-pen me-2 text-body text-opacity-50 my-n1"></i> Edit</a></div>
            </div> -->
                            <form method="POST"
                                action="/admin/sports-center/update-sports-center/<%= sportsCenter.id %>?_method=PUT">
                                <div class="row gx-4">
                                    <div class="col-xl-8">
                                        <div class="card mb-4">
                                            <div class="card-header bg-none fw-bold"> Sports Center Information </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <label class="form-label">Sports Center Name <span
                                                            class="text-danger">*</span></label>
                                                    <input type="text" class="form-control" name="sports_center_name"
                                                        placeholder="Sports Center name"
                                                        value="<%= sportsCenter.sports_center_name %>" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Address</label>
                                                    <input type="text" class="form-control" name="sports_center_address"
                                                        placeholder="Address"
                                                        value="<%= sportsCenter.sports_center_address %>" required>
                                                </div>
                                                <div class="row">
                                                    <div class="col-lg-6">
                                                        <div class="mb-3">
                                                            <label class="form-label">Website</label>
                                                            <input type="text" class="form-control"
                                                                value="<%= sportsCenter.website %>" name="website"
                                                                placeholder="Website" required>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-6">
                                                        <div class="mb-3">
                                                            <label class="form-label">Phone Number</label>
                                                            <input type="number" class="form-control"
                                                                value="<%= sportsCenter.phone %>" name="phone"
                                                                placeholder="Phone Number" required>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-lg-6">
                                                        <div class="mb-3">
                                                            <label class="form-label">Longitude</label>
                                                            <input type="text" class="form-control" name="longitude"
                                                                value="<%= sportsCenter.longitude %>"
                                                                placeholder="Longitude" required>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-6">
                                                        <div class="mb-3">
                                                            <label class="form-label">Latitude</label>
                                                            <input type="text" class="form-control" name="latitude"
                                                                value="<%= sportsCenter.latitude %>"
                                                                placeholder="Latitude" required>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="">
                                                    <label class="form-label">Sports Center Description <span
                                                            class="text-danger">*</span></label>
                                                    <textarea class="form-control" id="summernote" rows="10"
                                                        name="sports_center_description"
                                                        required><%= sportsCenter.sports_center_description %></textarea>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card mb-4">
                                            <div class="card-header bg-none fw-bold d-flex align-items-center">
                                                <div class="flex-1">
                                                    <div>Update Cover Image</div>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <input type="file" class="form-control" id="coverImageInput"
                                                    name="cover_photo" accept="image/*">
                                                <center>
                                                    <div class="mt-3">
                                                        <img id="coverImagePreview"
                                                            src="/cover_photo/<%= sportsCenter.cover_image %>"
                                                            alt="Image Preview"
                                                            class="img-fluid rounded <%= sportsCenter.cover_image ? '' : 'd-none' %>"
                                                            style="max-height: 250px;" />
                                                    </div>
                                                </center>
                                            </div>
                                        </div>
                                        <center><button class="btn btn-primary" type="submit">Save Changes</button>
                                        </center>
                                    </div>
                                    <div class="col-xl-4">
                                        <div class="card mb-4">
                                            <div class="card-header d-flex align-items-center  bg-none fw-semibold">
                                                Courts (<%= sportsCenter.courts.length %>) <!-- <a href="#"
                                class="ms-auto text-decoration-none text-primary fs-13px d-flex align-items-center"><i
                                    class="fa fa-plus-circle me-2 my-n1"></i> Add Court</a> -->
                                            </div>
                                            <div class="card-body">
                                                <% if (sportsCenter.courts.length> 0) { %> <%
                                                        sportsCenter.courts.forEach(court=> { %> <div
                                                            class="row align-items-center">
                                                            <div class="col-lg-8 d-flex align-items-center">
                                                                <div
                                                                    class="h-65px w-65px d-flex align-items-center justify-content-center position-relative bg-body rounded p-2">
                                                                    <i class="fa fa-box"></i>
                                                                    <img src="assets/img/product/product-1-thumb.png"
                                                                        alt="" class="mw-100 mh-100">
                                                                </div>
                                                                <div class="ps-3 flex-1">
                                                                    <div>
                                                                        <a href="#"
                                                                            class="text-decoration-none text-body">
                                                                            <%= court.court_name %>
                                                                        </a>
                                                                    </div>
                                                                    <div class="d-flex flex-wrap gap-2 mt-1">
                                                                        <span class="badge bg-primary">Location: <%=
                                                                                court.court_location %>
                                                                        </span>
                                                                        <span class="badge bg-success ">Game: <%=
                                                                                court.activity %></span>
                                                                        <span class="badge bg-info ">Court Type: <%=
                                                                                court.court_type %>
                                                                        </span>
                                                                    </div>
                                                                    <% if (Array.isArray(court.court_data) &&
                                                                        court.court_data.length> 0) { %> <div
                                                                            class="mt-3">
                                                                            <div class="row g-3">
                                                                                <% court.court_data.forEach((entry)=> {
                                                                                    %> <div class="col-auto">
                                                                                        <div class="border rounded text-center p-2"
                                                                                            style="min-width: 100px;">
                                                                                            <div class="fw-bold">₦<%=
                                                                                                    entry.price %>
                                                                                            </div>
                                                                                            <div
                                                                                                class="text-muted small">
                                                                                                <%= entry.duration %>
                                                                                                    mins
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                    <% }); %>
                                                                            </div>
                                                                        </div>
                                                                        <% } else { %>
                                                                            <div class="small text-muted mt-2">No
                                                                                pricing data available.</div>
                                                                            <% } %>
                                                                </div>
                                                            </div>
                                                            <div class="col-lg-2 m-0 ps-lg-3"></div>
                                                            <div class="col-lg-2 m-0 text-end">
                                                                <a href="#" class="text-primary p-2 open-edit-modal"
                                                                    title="Edit" data-bs-toggle="modal"
                                                                    data-bs-target="#editModalCoverExample"
                                                                    data-id="<%= court.id %>"
                                                                    data-name="<%= court.court_name %>"
                                                                    data-location="<%= court.court_location %>"
                                                                    data-type="<%= court.court_type %>"
                                                                    data-activity="<%= court.activity %>"
                                                                    data-position="<%= court.court_position %>"
                                                                    data-pricing='<%= JSON.stringify(court.court_data || []) %>'>
                                                                    <i class="fas fa-pen"></i>
                                                                </a>
                                                                <button type="button"
                                                                    class="btn btn-link text-danger me-2"
                                                                    data-bs-toggle="modal" data-bs-target="#modalSm"
                                                                    data-court-id="<%= court.id %>"><i
                                                                        class="fas fa-trash-alt"></i></button>
                                                            </div>
                                                        </div>
                                                        <hr class="opacity-1 my-4">
                                                        <% }); %>
                                                            <% } else { %>
                                                                <div class="text-center text-muted py-4">
                                                                    <p>No courts found for this sports center.</p>
                                                                </div>
                                                                <% } %>
                                            </div>
                                            <!-- <div class="card-footer bg-none d-flex p-3">
                            <a href="#" class="btn btn-default fw-semibold fs-13px ms-auto dropdown-toggle">More</a>
                            <a href="#" class="btn btn-theme fw-semibold fs-13px ms-2">Add Tracking</a>
                        </div> -->
                                        </div>
                                        <div class="card mb-4">
                                            <div class="card-header bg-none fw-bold d-flex align-items-center">
                                                <div class="flex-1">Features</div>
                                            </div>
                                            <div class="card-body">
                                                <div id="featuresDropdown"
                                                    data-features='<%= sportsCenter.sports_center_features || "[]" %>'>
                                                </div>
                                                <input type="hidden" name="sports_center_features" id="featuresInput"
                                                    required>
                                            </div>
                                        </div>
                                        <div class="card mb-4">
                                            <div class="card-header bg-none fw-bold d-flex align-items-center">
                                                <div class="flex-1">Games</div>
                                            </div>
                                            <div class="card-body">
                                                <div id="gamesDropdown"
                                                    data-games='<%= sportsCenter.sports_center_games || "[]" %>'></div>
                                                <input type="hidden" name="sports_center_games" id="gamesInput"
                                                    required>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
        </div>
        <div class="modal modal-cover fade" id="modalCoverExample">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Create Court</h3>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p class="mb-3"> Add a new court to your sports facility. A court represents a specific area or
                            space where a particular sport or activity takes place (e.g., tennis court, basketball
                            court, snooker table).</p>
                        <form method="POST" action="admin/sports-centers/create-court/<%= sportsCenter.id %>">
                            <div class="row mb-5">
                                <div class="col-md-12 mb-3">
                                    <input type="text" id="court_name" name="court_name" placeholder="Court Name"
                                        class="form-control form-control-sm" required>
                                </div>
                                <div class="col-md-12 mb-3">
                                    <select id="court_location" name="court_location"
                                        class="form-control form-control-sm" required>
                                        <option value="">Select Court Location</option>
                                        <option value="Indoor">Indoor</option>
                                        <option value="Outdoor">Outdoor</option>
                                    </select>
                                </div>
                                <div class="col-md-12 mb-3">
                                    <select id="court_type" name="court_type" class="form-control form-control-sm"
                                        required>
                                        <option value="">Select Court Type</option>
                                        <option value="court">Court</option>
                                        <option value="table">Table</option>
                                        <option value="board">Board</option>
                                    </select>
                                </div>
                                <div class="col-md-12 mb-3">
                                    <select id="activity" name="activity" class="form-control form-control-sm" required>
                                        <option value="">Select Activity</option>
                                        <option value="padel">Padel</option>
                                        <option value="snooker">Snooker</option>
                                        <option value="darts">Darts</option>
                                    </select>
                                </div>
                                <div class="col-md-12 mb-3">
                                    <select id="court_position" name="court_position"
                                        class="form-control form-control-sm" required>
                                        <option value="">Select Court Position</option>
                                        <option value="left">Left</option>
                                        <option value="right">Right</option>
                                        <option value="center">Center</option>
                                        <option value="n/a">N/A</option>
                                    </select>
                                </div>
                                <div class="col-md-12 mb-3">
                                    <label><strong>Court Price Duration</strong></label>
                                    <div id="price-duration-wrapper">
                                        <!-- Will be filled dynamically -->
                                    </div>
                                    <button type="button" id="add-price-duration"
                                        class="btn btn-secondary btn-sm mt-2">+ Add Another</button>
                                </div>
                                <div class="col-md-12">
                                    <button type="submit" class="btn btn-primary btn-lg btn-block">Submit</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal modal-cover fade" id="editModalCoverExample">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Edit Court</h3>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p class="mb-3">Update court to your sports facility. A court represents a specific area or
                            space where a particular sport or activity takes place (e.g., darts board, padel court,
                            snooker table).</p>
                        <form method="POST" id="editCourtForm" action="">
                            <input type="hidden" id="edit_court_id" name="court_id" />
                            <div class="row mb-5">
                                <div class="col-md-12 mb-3">
                                    <input type="text" id="edit_court_name" name="court_name" placeholder="Court Name"
                                        class="form-control form-control-sm" required>
                                </div>
                                <div class="col-md-12 mb-3">
                                    <select id="edit_court_location" name="court_location"
                                        class="form-control form-control-sm" required>
                                        <option value="">Select Court Location</option>
                                        <option value="Indoor">Indoor</option>
                                        <option value="Outdoor">Outdoor</option>
                                    </select>
                                </div>
                                <div class="col-md-12 mb-3">
                                    <select id="edit_court_type" name="court_type" class="form-control form-control-sm"
                                        required>
                                        <option value="">Select Court Type</option>
                                        <option value="court">Court</option>
                                        <option value="table">Table</option>
                                        <option value="board">Board</option>
                                    </select>
                                </div>
                                <div class="col-md-12 mb-3">
                                    <select id="edit_activity" name="activity" class="form-control form-control-sm"
                                        required>
                                        <option value="">Select Activity</option>
                                        <option value="padel">Padel</option>
                                        <option value="snooker">Snooker</option>
                                        <option value="darts">Darts</option>
                                    </select>
                                </div>
                                <div class="col-md-12 mb-3">
                                    <select id="edit_court_position" name="court_position"
                                        class="form-control form-control-sm" required>
                                        <option value="">Select Court Position</option>
                                        <option value="left">Left</option>
                                        <option value="right">Right</option>
                                        <option value="center">Center</option>
                                        <option value="n/a">N/A</option>
                                    </select>
                                </div>
                                <div class="col-md-12 mb-3">
                                    <label><strong>Court Price Duration</strong></label>
                                    <div id="edit_price_duration_wrapper">
                                        <!-- Will be filled dynamically -->
                                    </div>
                                    <button type="button" id="edit_add_price_duration"
                                        class="btn btn-secondary btn-sm mt-2">+ Add Another</button>
                                </div>
                                <div class="col-md-12">
                                    <button type="submit" class="btn btn-primary btn-lg btn-block">Submit</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="modalSm">
            <div class="modal-dialog modal-sm">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Confirm Delete</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to delete this court?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
                        <form id="deleteCourtForm" method="POST" class="d-inline">
                            <button type="submit" class="btn btn-danger">Yes</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <script>
            const modalSm = document.getElementById('modalSm');
            const deleteForm = document.getElementById('deleteCourtForm');

            modalSm.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget; // Button that triggered the modal
                const courtId = button.getAttribute('data-court-id'); // Extract ID

                // Update form action dynamically
                deleteForm.action = `/admin/sports-centers/delete-court/${courtId}?_method=DELETE`;
            });
        </script>
        <!-- END #content -->
        <!-- BEGIN btn-scroll-top -->
        <script>
            let index = 0;

            function createEntry(i) {
                return `
          <div class="row price-duration-entry mb-2" data-index="${i}">
            <div class="col-md-5">
              <input type="number" name="court_price_duration[${i}][price]" class="form-control form-control-sm" placeholder="Price" required />
            </div>
            <div class="col-md-5">
              <input type="number" name="court_price_duration[${i}][duration]" class="form-control form-control-sm" placeholder="Duration (e.g. 30)" required />
            </div>
            <div class="col-md-2">
              <button type="button" class="btn btn-danger btn-sm remove-entry">X</button>
            </div>
          </div>
        `;
            }

            document.getElementById('add-price-duration').addEventListener('click', function () {
                const wrapper = document.getElementById('price-duration-wrapper');
                wrapper.insertAdjacentHTML('beforeend', createEntry(index));
                index++;
            });

            document.addEventListener('click', function (e) {
                if (e.target.classList.contains('remove-entry')) {
                    const entry = e.target.closest('.price-duration-entry');
                    entry.remove();
                }
            });

            // Add initial entry
            document.getElementById('price-duration-wrapper').insertAdjacentHTML('beforeend', createEntry(index));
            index++;
        </script>
        <script>
            document.getElementById('coverImageInput').addEventListener('change', function (event) {
                const file = event.target.files[0];
                const preview = document.getElementById('coverImagePreview');

                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();

                    reader.onload = function (e) {
                        preview.src = e.target.result;
                        preview.classList.remove('d-none');
                    };

                    reader.readAsDataURL(file);
                } else {
                    preview.src = '#';
                    preview.classList.add('d-none');
                }
            });
        </script>
        <script>
            function createMultiSelectDropdown(containerId, inputId, options, selected = []) {
                const container = document.getElementById(containerId);
                const input = document.getElementById(inputId);

                container.innerHTML = "";

                const toggle = document.createElement("button");
                toggle.className = "btn btn-secondary dropdown-toggle";
                toggle.setAttribute("data-bs-toggle", "dropdown");
                toggle.type = "button";
                toggle.textContent = "Choose Options";

                const dropdown = document.createElement("ul");
                dropdown.className = "dropdown-menu show p-2"; // remove 'show' for production

                const tagBox = document.createElement("div");
                tagBox.className = "mt-2 d-flex flex-wrap gap-2";

                options.forEach((option) => {
                    const li = document.createElement("li");
                    const checkbox = document.createElement("input");
                    checkbox.type = "checkbox";
                    checkbox.value = option;
                    checkbox.className = "form-check-input me-2";
                    if (selected.includes(option)) checkbox.checked = true;

                    const label = document.createElement("label");
                    label.className = "form-check-label";
                    label.textContent = option;

                    li.className = "dropdown-item";
                    li.appendChild(checkbox);
                    li.appendChild(label);
                    dropdown.appendChild(li);
                });

                function updateSelected() {
                    tagBox.innerHTML = "";
                    const values = [];
                    dropdown.querySelectorAll("input[type='checkbox']").forEach((cb) => {
                        if (cb.checked) {
                            values.push(cb.value);
                            const tag = document.createElement("span");
                            tag.className = "badge bg-primary text-white d-flex align-items-center";
                            tag.textContent = cb.value;
                            const removeBtn = document.createElement("button");
                            removeBtn.className = "btn-close btn-close-white ms-2";
                            removeBtn.onclick = () => {
                                cb.checked = false;
                                updateSelected();
                            };
                            tag.appendChild(removeBtn);
                            tagBox.appendChild(tag);
                        }
                    });
                    input.value = JSON.stringify(values);
                }

                dropdown.addEventListener("change", updateSelected);

                container.appendChild(toggle);
                container.appendChild(dropdown);
                container.appendChild(tagBox);

                updateSelected();
            }

            document.addEventListener("DOMContentLoaded", () => {
                const featuresContainer = document.getElementById("featuresDropdown");
                const gamesContainer = document.getElementById("gamesDropdown");

                let preSelectedFeatures = [];
                let preSelectedGames = [];

                try {
                    preSelectedFeatures = JSON.parse(featuresContainer.dataset.features || "[]");
                } catch (e) {
                    console.error("Invalid features JSON", e);
                }

                try {
                    preSelectedGames = JSON.parse(gamesContainer.dataset.games || "[]");
                } catch (e) {
                    console.error("Invalid games JSON", e);
                }

                createMultiSelectDropdown("featuresDropdown", "featuresInput", [
                    "Courts", "Lockers", "Shower Rooms",
                    "Equipment Rental", "Parking", "Snack Bar / Cafe", "Seating / Spectator Area",
                    "Scoreboards", "Booking", "Wheelchair", ,
                    "Lighting", "Changing Rooms", "Wi-Fi", "Pro Shop", "Membership"
                ], preSelectedFeatures);

                createMultiSelectDropdown("gamesDropdown", "gamesInput", [
                    "Padel", "Snooker", "Darts"
                ], preSelectedGames);
            });
        </script>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const editModal = document.getElementById("editModalCoverExample");

                document.querySelectorAll(".open-edit-modal").forEach(button => {
                    button.addEventListener("click", () => {
                        const courtId = button.dataset.id;
                        const name = button.dataset.name;
                        const location = button.dataset.location;
                        const type = button.dataset.type;
                        const activity = button.dataset.activity;
                        const position = button.dataset.position;
                        const pricing = JSON.parse(button.dataset.pricing || "[]");

                        const form = document.getElementById("editCourtForm");
                        form.action = `/admin/sports-centers/update-court/${courtId}?_method=PUT`;

                        // Fill form fields
                        document.getElementById("edit_court_name").value = name || "";
                        document.getElementById("edit_court_location").value = location || "";
                        document.getElementById("edit_court_type").value = type || "";
                        document.getElementById("edit_activity").value = activity || "";
                        document.getElementById("edit_court_position").value = position || "";

                        // Reset pricing fields
                        const wrapper = document.getElementById("edit_price_duration_wrapper");
                        wrapper.innerHTML = "";

                        pricing.forEach(item => {
                            const row = document.createElement("div");
                            row.className = "d-flex gap-2 mb-2";

                            row.innerHTML = `
                    <input type="number" name="price[]" class="form-control form-control-sm" placeholder="Price" value="${item.price}" required>
                    <input type="number" name="duration[]" class="form-control form-control-sm" placeholder="Duration (mins)" value="${item.duration}" required>
                    <button type="button" class="btn btn-sm btn-danger remove-row">×</button>
                `;

                            wrapper.appendChild(row);
                        });

                        // Add handler to remove buttons
                        wrapper.querySelectorAll(".remove-row").forEach(btn => {
                            btn.addEventListener("click", () => btn.parentElement.remove());
                        });
                    });
                });

                // Handle Add Another button
                document.getElementById("edit_add_price_duration").addEventListener("click", () => {
                    const row = document.createElement("div");
                    row.className = "d-flex gap-2 mb-2";

                    row.innerHTML = `
            <input type="number" name="price[]" class="form-control form-control-sm" placeholder="Price" required>
            <input type="number" name="duration[]" class="form-control form-control-sm" placeholder="Duration (mins)" required>
            <button type="button" class="btn btn-sm btn-danger remove-row">×</button>
        `;

                    const wrapper = document.getElementById("edit_price_duration_wrapper");
                    wrapper.appendChild(row);

                    row.querySelector(".remove-row").addEventListener("click", () => row.remove());
                });
            });

        </script>
        <%- include('../partials/footer') %>